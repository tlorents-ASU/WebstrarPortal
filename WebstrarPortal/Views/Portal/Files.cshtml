@model WebstrarPortal.Models.FileBrowserViewModel
@{
    ViewData["Title"] = $"Files - {Model.PageName}";
    var asurite = ViewBag.Asurite as string;
    var backUrl = ViewBag.BackUrl as string ?? "/portal";
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@backUrl">Dashboard</a></li>
        <li class="breadcrumb-item active">@Model.PageName</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>@Model.PageName - Files</h3>
    @if (Model.AspxFiles.Count == 0)
    {
        @* No .aspx files â€” no view button *@
    }
    else if (Model.EntryFile != null && (Model.AspxFiles.Any(f => f.Equals("Default.aspx", StringComparison.OrdinalIgnoreCase)) || Model.AspxFiles.Count == 1))
    {
        var label = Model.AspxFiles.Any(f => f.Equals("Default.aspx", StringComparison.OrdinalIgnoreCase))
            ? "View Live Page"
            : $"View {Model.EntryFile}";
        <a href="@Model.SiteBaseUrl/@Model.EntryFile" target="_blank" class="btn btn-success btn-sm">@label</a>
    }
    else
    {
        <div class="d-flex flex-wrap gap-2">
            @foreach (var aspx in Model.AspxFiles)
            {
                <a href="@Model.SiteBaseUrl/@aspx" target="_blank" class="btn btn-success btn-sm">View @aspx</a>
            }
        </div>
    }
</div>

@if (Model.Files.Count == 0)
{
    <div class="alert alert-warning">No files found in this page folder.</div>
}
else
{
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th class="text-end" style="width: 100px;">Size</th>
                        <th style="width: 180px;">Modified</th>
                    </tr>
                </thead>
                <tbody>
                    @{ RenderTree(Model.Files, 0); }
                </tbody>
            </table>
        </div>
    </div>
}

@functions {
    void RenderTree(List<WebstrarPortal.Models.FileNode> nodes, int depth)
    {
        var asurite = ViewBag.Asurite as string;
        foreach (var node in nodes)
        {
            var indent = depth * 20;
            if (node.IsDirectory)
            {
                <tr class="table-light">
                    <td style="padding-left: @(indent + 12)px;">
                        <strong>&#128193; @node.Name/</strong>
                    </td>
                    <td></td>
                    <td></td>
                </tr>
                RenderTree(node.Children, depth + 1);
            }
            else
            {
                var viewUrl = $"/portal/files/{Model.SiteNumber}/{Model.PageName}/view?path={Uri.EscapeDataString(node.RelativePath)}&asurite={asurite}";
                var sizeStr = FormatSize(node.Size);
                <tr>
                    <td style="padding-left: @(indent + 12)px;">
                        <a href="@viewUrl">&#128196; @node.Name</a>
                    </td>
                    <td class="text-end text-muted small">@sizeStr</td>
                    <td class="text-muted small">@node.LastModified.ToString("yyyy-MM-dd HH:mm")</td>
                </tr>
            }
        }
    }

    string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}
