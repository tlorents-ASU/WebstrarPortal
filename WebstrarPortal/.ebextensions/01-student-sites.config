files:
  "c:\\ebscripts\\setup-student-sites.ps1":
    content: |
      $ErrorActionPreference = "Stop"

      $siteName   = "Default Web Site"
      $deployRoot = "C:\WebstrarDeploy"
      $appPool    = "WebstrarNetFx"
      $appcmd     = Join-Path $env:windir "System32\inetsrv\appcmd.exe"
      $logFile    = Join-Path $deployRoot "_setup_log.txt"

      # Student site ranges: 2-98, 101-199 | Pages 0-10
      $siteNumbers = @(2..98) + @(101..199)
      $pageNumbers = @(0..10)

      function Log($msg) {
        $ts = (Get-Date).ToString("s")
        Add-Content -Path $logFile -Value "$ts  $msg"
      }

      try {
        New-Item -ItemType Directory -Force -Path $deployRoot | Out-Null
        Log "Starting IIS student-site setup..."

        if (-not (Test-Path $appcmd)) { throw "appcmd.exe not found at $appcmd" }

        # 1) Permissions
        Log "Setting ACL on $deployRoot for IIS_IUSRS..."
        cmd /c "icacls `"$deployRoot`" /grant `"IIS_IUSRS:(OI)(CI)(M)`" /T" | Out-Null

        # 2) Ensure App Pool (appcmd is fine for one-off calls)
        Log "Ensuring app pool: $appPool"
        $poolExists = & $appcmd list apppool "$appPool" /text:name
        if (-not $poolExists) {
          & $appcmd add apppool /name:"$appPool" | Out-Null
          Log "Created app pool"
        }
        & $appcmd set apppool "$appPool" /managedRuntimeVersion:v4.0 | Out-Null
        & $appcmd set apppool "$appPool" /managedPipelineMode:Integrated | Out-Null
        Log "Configured app pool"

        # 3) Use ServerManager for bulk IIS app creation (much faster than appcmd per-app)
        Log "Loading IIS ServerManager..."
        [System.Reflection.Assembly]::LoadFrom("$env:windir\System32\inetsrv\Microsoft.Web.Administration.dll") | Out-Null
        $mgr = New-Object Microsoft.Web.Administration.ServerManager

        $site = $mgr.Sites[$siteName]
        if (-not $site) { throw "IIS site '$siteName' not found" }

        # Build lookup of existing app paths
        $existingApps = @{}
        foreach ($app in $site.Applications) {
          $existingApps[$app.Path] = $true
        }
        Log "Found $($existingApps.Count) existing IIS apps"

        # Ensure /sites root app
        if (-not $existingApps.ContainsKey("/sites")) {
          $rootApp = $site.Applications.Add("/sites", $deployRoot)
          $rootApp.ApplicationPoolName = $appPool
          Log "Created /sites root app"
        } else {
          $site.Applications["/sites"].ApplicationPoolName = $appPool
        }

        # 4) Create all student site/page apps in memory
        $created = 0
        $skipped = 0
        foreach ($w in $siteNumbers) {
          foreach ($p in $pageNumbers) {
            $appPath = "/sites/website{0}/Page{1}" -f $w, $p
            $pageDir = Join-Path $deployRoot ("website{0}\Page{1}" -f $w, $p)

            New-Item -ItemType Directory -Force -Path $pageDir | Out-Null

            if (-not $existingApps.ContainsKey($appPath)) {
              $app = $site.Applications.Add($appPath, $pageDir)
              $app.ApplicationPoolName = $appPool
              $created++
            } else {
              $skipped++
            }
          }
        }
        Log "Prepared $created new apps, $skipped already exist"

        # 5) Commit all changes at once
        Log "Committing to IIS..."
        $mgr.CommitChanges()
        $mgr.Dispose()
        Log "Committed successfully"

        # Create all directories (in case commit happened before all mkdir)
        foreach ($w in $siteNumbers) {
          foreach ($p in $pageNumbers) {
            $pageDir = Join-Path $deployRoot ("website{0}\Page{1}" -f $w, $p)
            New-Item -ItemType Directory -Force -Path $pageDir | Out-Null
          }
        }

        Set-Content -Path (Join-Path $deployRoot "_iis_site_name.txt") -Value $siteName -Encoding ASCII
        Log "Setup complete. Created: $created, Skipped: $skipped"
      }
      catch {
        Log "ERROR: $($_.Exception.Message)"
        throw
      }

commands:
  01_run_setup:
    command: powershell -ExecutionPolicy Bypass -NoProfile -File "c:\\ebscripts\\setup-student-sites.ps1"
    waitAfterCompletion: 0
