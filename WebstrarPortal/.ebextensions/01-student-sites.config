files:
  "c:\\ebscripts\\setup-student-sites.ps1":
    content: |
      $ErrorActionPreference = "Stop"

      $siteName   = "Default Web Site"
      $deployRoot = "C:\WebstrarDeploy"
      $appPool    = "WebstrarNetFx"
      $appcmd     = Join-Path $env:windir "System32\inetsrv\appcmd.exe"
      $logFile    = Join-Path $deployRoot "_setup_log.txt"

      function Log($msg) {
        $ts = (Get-Date).ToString("s")
        Add-Content -Path $logFile -Value "$ts  $msg"
      }

      try {
        # 0) Ensure folder exists for logs + content
        New-Item -ItemType Directory -Force -Path $deployRoot | Out-Null
        Log "Starting IIS student-site setup..."
        Log "appcmd: $appcmd"

        if (-not (Test-Path $appcmd)) { throw "appcmd.exe not found at $appcmd" }

        # 1) Permissions for IIS to read/write student content
        Log "Setting ACL on $deployRoot for IIS_IUSRS..."
        cmd /c "icacls `"$deployRoot`" /grant `"IIS_IUSRS:(OI)(CI)(M)`" /T" | Out-Null

        # 2) Ensure App Pool exists
        Log "Ensuring app pool exists: $appPool"
        $poolExists = & $appcmd list apppool "$appPool" /text:name
        if (-not $poolExists) {
          & $appcmd add apppool /name:"$appPool" | Out-Null
          Log "Created app pool $appPool"
        } else {
          Log "App pool already exists"
        }

        # Configure app pool for .NET Framework v4
        & $appcmd set apppool "$appPool" /managedRuntimeVersion:v4.0 | Out-Null
        & $appcmd set apppool "$appPool" /managedPipelineMode:Integrated | Out-Null
        Log "Configured app pool runtime=v4.0 pipeline=Integrated"

        # 3) Ensure /sites is an IIS APPLICATION pointing to C:\WebstrarDeploy
        $sitesPath = "/sites"
        Log "Ensuring IIS app exists: $sitesPath -> $deployRoot"

        $apps = & $appcmd list app /site.name:"$siteName" /text:path
        $sitesAppExists = $apps | Select-String -SimpleMatch $sitesPath

        if (-not $sitesAppExists) {
          # remove any vdir at /sites so we can create an app
          & $appcmd delete vdir /vdir.name:"$siteName$sitesPath" 2>$null
          & $appcmd add app /site.name:"$siteName" /path:"$sitesPath" /physicalPath:"$deployRoot" | Out-Null
          Log "Created IIS app $sitesPath"
        } else {
          Log "IIS app already exists at $sitesPath"
        }

        & $appcmd set app "$siteName$sitesPath" /applicationPool:"$appPool" | Out-Null
        Log "Assigned app pool to $sitesPath"

        # 4) Create ONLY the one app we need for proof: /sites/website2/Page0
        $w = 2
        $p = 0
        $pageDir = Join-Path $deployRoot ("website{0}\Page{1}" -f $w, $p)
        New-Item -ItemType Directory -Force -Path $pageDir | Out-Null

        $path = ("/sites/website{0}/Page{1}" -f $w, $p)
        Log "Ensuring IIS app exists: $path -> $pageDir"

        # delete any vdir with that name (harmless if missing)
        & $appcmd delete vdir /vdir.name:"$siteName$path" 2>$null

        $apps = & $appcmd list app /site.name:"$siteName" /text:path
        $appExists = $apps | Select-String -SimpleMatch $path

        if (-not $appExists) {
          & $appcmd add app /site.name:"$siteName" /path:"$path" /physicalPath:"$pageDir" | Out-Null
          Log "Created IIS app $path"
        } else {
          & $appcmd set app "$siteName$path" /physicalPath:"$pageDir" | Out-Null
          Log "Updated IIS app physicalPath for $path"
        }

        & $appcmd set app "$siteName$path" /applicationPool:"$appPool" | Out-Null
        Log "Assigned app pool to $path"

        # proof file
        Set-Content -Path (Join-Path $deployRoot "_iis_site_name.txt") -Value $siteName -Encoding ASCII
        Log "Wrote proof file _iis_site_name.txt"
        Log "Setup complete OK."
      }
      catch {
        Log "ERROR: $($_.Exception.Message)"
        throw
      }

commands:
  01_run_setup:
    command: powershell -ExecutionPolicy Bypass -NoProfile -File "c:\\ebscripts\\setup-student-sites.ps1"
